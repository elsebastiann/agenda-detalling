{% extends "base.html" %}

{% block content %}
<h2>Editar cita</h2>

<form method="post" class="row gy-3">

  <div class="col-md-3">
    <label class="form-label">Placa</label>
    <input type="text" name="plate" id="plate" class="form-control"
           value="{{ appointment.plate }}"
           style="text-transform: uppercase;">
  </div>

  <div class="col-md-4">
    <label class="form-label">Nombre del cliente</label>
    <input type="text" name="customer_name" id="customer_name" class="form-control"
           value="{{ appointment.customer_name }}" required>
  </div>

  <div class="col-md-3">
    <label class="form-label">Teléfono</label>
    <input type="text" name="phone" id="phone" class="form-control" value="{{ appointment.phone }}"
           pattern="\d{10}" maxlength="10" minlength="10"
           placeholder="3001234567" required>
  </div>

  <div class="col-md-3">
    <label class="form-label">Fecha</label>
    <input type="date" name="date" class="form-control"
           value="{{ appointment.start_datetime.strftime('%Y-%m-%d') }}" required>
  </div>

  <div class="col-md-3">
    <label class="form-label">Hora de inicio</label>
    <input type="time" name="start_time" id="start_time"
           class="form-control"
           step="900"
           list="timeOptions"
           value="{{ appointment.start_datetime.strftime('%H:%M') }}"
           required>
    <datalist id="timeOptions"></datalist>
    <div class="form-text">Minutos en intervalos de 15.</div>
  </div>


  <!-- Servicios -->
  <div class="col-12">
    <label class="form-label">Servicios</label>
    <select name="service_ids" class="form-select" multiple size="8" required>
      {% for s in services %}
        <option value="{{ s.id }}"
          {% if s.name in appointment.services %}selected{% endif %}>
            {{ s.name }} ({{ s.duration_minutes }} min)
        </option>
      {% endfor %}
    </select>
    <div class="form-text">Puedes seleccionar múltiples servicios (Cmd/Ctrl + clic).</div>
  </div>

  <div class="col-12">
    <label class="form-label">Notas</label>
    <textarea name="notes" class="form-control" rows="3">{{ appointment.notes }}</textarea>
  </div>

  <div class="col-12 mt-3">
    <button type="submit" class="btn btn-primary">Guardar cambios</button>
    <a href="{{ url_for('appointments_list') }}" class="btn btn-secondary">Cancelar</a>
  </div>

</form>
<script>
  // Autocompletar datos del cliente por placa (edición)
  const plateEl = document.getElementById("plate");
  const nameEl = document.getElementById("customer_name");
  const phoneEl = document.getElementById("phone");

  // Forzar mayúsculas mientras escribe
  plateEl?.addEventListener("input", () => {
    plateEl.value = plateEl.value.toUpperCase();
  });

  let plateTimer = null;
  let lastPlateQueried = "";

  function normalizePlate(value) {
    return (value || "").replace(/\s+/g, "").toUpperCase();
  }

  async function fetchClientByPlate(plate) {
    try {
      const resp = await fetch(`/api/clients/by-plate?plate=${encodeURIComponent(plate)}`);
      if (!resp.ok) return null;
      return await resp.json();
    } catch (e) {
      return null;
    }
  }

  async function tryAutofillByPlate() {
    const plate = normalizePlate(plateEl?.value);
    if (!plate || plate.length < 4) return;

    if (plate === lastPlateQueried) return;
    lastPlateQueried = plate;

    const data = await fetchClientByPlate(plate);
    if (!data || !data.found) return;

    // En edición: solo rellenar si el usuario dejó el campo vacío
    if (nameEl && !nameEl.value.trim()) nameEl.value = data.full_name || "";
    if (phoneEl && !phoneEl.value.trim()) phoneEl.value = (data.phone || "").replace(/\D/g, "").slice(0, 10);
  }

  plateEl?.addEventListener("input", () => {
    clearTimeout(plateTimer);
    plateTimer = setTimeout(tryAutofillByPlate, 450);
  });

  plateEl?.addEventListener("blur", () => {
    clearTimeout(plateTimer);
    tryAutofillByPlate();
  });

  // Hora en un solo selector (input time) + validación/snap a 15 min (07:00 a 20:00)
  const startTimeEl = document.getElementById("start_time");
  const datalistEl = document.getElementById("timeOptions");

  function pad2(n){ return String(n).padStart(2,'0'); }

  function clampTimeToRange(hh, mm, minH=7, maxH=20) {
    if (hh < minH) return {hh: minH, mm: 0};
    if (hh > maxH) return {hh: maxH, mm: 0};
    if (hh === maxH) return {hh: maxH, mm: 0}; // 20:00 máximo
    return {hh, mm};
  }

  function snapTo15(value) {
    if (!value || !value.includes(":")) return "";
    let [h, m] = value.split(":");
    let hh = parseInt(h, 10);
    let mm = parseInt(m, 10);
    if (Number.isNaN(hh) || Number.isNaN(mm)) return "";

    // Snap al múltiplo más cercano de 15
    mm = Math.round(mm / 15) * 15;
    if (mm === 60) { mm = 0; hh += 1; }

    const c = clampTimeToRange(hh, mm, 7, 20);
    hh = c.hh; mm = c.mm;

    return `${pad2(hh)}:${pad2(mm)}`;
  }

  function buildTimeDatalist() {
    if (!datalistEl) return;
    datalistEl.innerHTML = "";
    for (let h = 7; h <= 20; h++) {
      for (let m = 0; m < 60; m += 15) {
        if (h === 20 && m > 0) continue;
        const opt = document.createElement("option");
        opt.value = `${pad2(h)}:${pad2(m)}`;
        datalistEl.appendChild(opt);
      }
    }
  }

  buildTimeDatalist();

  // Snap/validación al cambiar o al salir
  startTimeEl?.addEventListener("change", () => {
    startTimeEl.value = snapTo15(startTimeEl.value) || startTimeEl.value;
  });
  startTimeEl?.addEventListener("blur", () => {
    startTimeEl.value = snapTo15(startTimeEl.value) || startTimeEl.value;
  });
</script>
{% endblock %}