{% extends "base.html" %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">

<style>
  html, body {
    height: 100%;
    margin: 0;
    padding: 0;
  }

  #calendar-container {
    height: calc(100vh - 140px); /* espacio para navbar + margen */
    width: 100%;
    max-width: 1400px;
    margin: 0 auto;
  }

  #calendar {
    height: 100% !important;
    width: 100%;
    background-color: #1e1e1e;
    border-radius: 10px;
    padding: 10px;
    overflow: visible !important;
  }

  /* Texto oscuro dentro de los eventos del calendario */
  .fc-event-title, 
  .fc-event-main, 
  .fc-event {
    color: #000 !important;
  }
</style>
{% endblock %}

{% block content %}
<h2 class="mb-3 text-center">Agenda semanal</h2>

<div id="calendar-container">
  <div id="calendar"></div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.global.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  var calendarEl = document.getElementById('calendar');

  var calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'timeGridWeek',
    locale: 'es',
    slotMinTime: '07:00:00',
    slotMaxTime: '20:00:00',
    nowIndicator: true,
    allDaySlot: false,
    expandRows: true,
    height: '100%',
    handleWindowResize: true,

    eventContent: function(info) {
      let wrapper = document.createElement("div");
      wrapper.style.height = "100%";
      wrapper.style.display = "flex";
      wrapper.style.position = "relative";
      wrapper.style.borderRadius = "6px";
      wrapper.style.overflow = "hidden";

      let parts = info.event.extendedProps.colors || [];

      parts.forEach(p => {
          let block = document.createElement("div");
          block.style.flex = p.percent;
          block.style.backgroundColor = p.color;
          wrapper.appendChild(block);
      });

      // Texto arriba
      let text = document.createElement("div");
      text.innerHTML = `<b>${info.event.title}</b>`;
      text.style.position = "absolute";
      text.style.top = "4px";
      text.style.left = "6px";
      text.style.fontSize = "11px";
      text.style.color = "#000";

      wrapper.appendChild(text);

      return { domNodes: [wrapper] };
    },


    eventClick: function(info) {
      let id = info.event.id;

      fetch(`/appointment/${id}/json`)
        .then(res => res.json())
        .then(data => {

          document.getElementById("modalBodyContent").innerHTML = `
            <p><b>Cliente:</b> ${data.customer_name}</p>
            <p><b>Placa:</b> ${data.plate || 'Sin placa'}</p>
            <p><b>Tel√©fono:</b> ${data.phone || 'No registrado'}</p>
            <p><b>Servicios:</b> ${data.services}</p>
            <p><b>Inicio:</b> ${data.start}</p>
            <p><b>Fin:</b> ${data.end}</p>
            <p><b>Notas:</b> ${data.notes || 'Sin notas'}</p>

            <a href="/appointment/${data.id}/edit" class="btn btn-primary mt-2">
              Editar cita
            </a>
          `;

          let modal = new bootstrap.Modal(document.getElementById("appointmentModal"));
          modal.show();
        });
    },

    events: '/api/events',
    displayEventTime: false,
    eventColor: null,
});

  calendar.render();
});
</script>
{% endblock %}